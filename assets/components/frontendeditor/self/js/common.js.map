{"version":3,"sources":["src/common.js"],"names":["FrontendEditor","editingMode","saved","document","querySelector","innerHTML","frontendEditorOptions","frontendEditorLexicon","options","lexicon","editPermission","classList","add","fe","editableAreas","querySelectorAll","selector","forEach","call","el","addEventListener","edit","bind","frontendeditor","save","$onloadFunction","$process","data","FormData","append","id","_send","currentTarget","error","status","response","success","fileds","object","constructor","generateUUID","dataset","frontendeditorLoadData","messageBoxShow","parentElement","children","style","visibility","disabled","loadContent","tinymceInit","toggle","remove","hasChange","confirm","tinymce","result","tinyMCE","get","undoManager","hasUndo","encodeURIComponent","onloadFunction","xhr","XMLHttpRequest","open","url","responseType","onload","send","messageBox","setTimeout","config","language","lang","images_upload_handler","blobInfo","failure","formData","blob","filename","message","tinymceConfig","tinymceConfigString","_decodeEntities","Object","assign","JSON","parse","init","d","Date","getTime","d2","performance","now","replace","c","r","Math","random","floor","toString","encodedString","textArea","createElement","value"],"mappings":"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","file":"common.js","sourcesContent":["class FrontendEditor {\n\n    constructor(){\n        this.editingMode = false;\n        this.saved = false;\n\n        document.querySelector(`body`).innerHTML+= `<div class=\"frontendeditor-topbabr\">\n            <div class=\"frontendeditor-message-box\"></div>\n            <button class=\"frontendeditor-button frontendeditor-button-edit\"><i class=\"far fa-edit\"></i><i class=\"far fa-times-circle\"></i></button>\n            <button class=\"frontendeditor-button frontendeditor-button-save\"><i class=\"far fa-save\"></i></button>\n        </div>`;\n\n    }\n\n    init(frontendEditorOptions, frontendEditorLexicon){\n        this.options = frontendEditorOptions;\n        this.lexicon = frontendEditorLexicon;\n\n        if(this.options.editPermission !== `1`){\n            document.querySelector(`.frontendeditor-topbabr`).classList.add(`noEditPermission`);\n        }else{\n            const fe = this;\n            fe.editableAreas = [...document.querySelectorAll(fe.options.selector)];\n\n            [].forEach.call(document.querySelectorAll(`.frontendeditor-button-edit`), function (el) {\n                el.addEventListener(`click`, fe.edit.bind(fe), false);\n                el.frontendeditor = fe;\n            });\n\n            [].forEach.call(document.querySelectorAll(`.frontendeditor-button-save`), function (el) {\n                el.addEventListener(`click`, fe.save.bind(fe));\n            });\n        }\n    }\n\n    loadContent($onloadFunction, $process = false) {\n\n        let data = new FormData();\n        data.append(\"action\", \"getall\");\n        data.append(\"id\", this.options.id);\n        data.append(\"process\", $process);\n\n        this._send(data, function ({currentTarget}) {\n            let error = false;\n            if (currentTarget.status === 200 && currentTarget.response.success) {\n                let fileds = currentTarget.response.object;\n                this.editableAreas.forEach(function (el) {\n                    el.id = this.constructor.generateUUID();\n                    if(el.dataset.frontendeditor in fileds) {\n                        el.innerHTML = fileds[el.dataset.frontendeditor];\n                        el.dataset.frontendeditorLoadData = `true`;\n                    }else{\n                        this.constructor.messageBoxShow().innerHTML = `${this.lexicon['error_content_for']} ${el.dataset.frontendeditor}`;\n                        error = true;\n                    }\n                }.bind(this));\n            } else {\n                this.constructor.messageBoxShow().innerHTML = `${this.lexicon['error_content_load']}<br>${currentTarget.status}`;\n                error = true;\n            }\n            if(!error){\n                $onloadFunction();\n            }\n        }.bind(this))\n    }\n\n    edit({currentTarget}) {\n        const fe = this;\n\n        currentTarget.parentElement.children[1].style.visibility = `visible`;\n\n        if(!fe.editingMode) {\n            currentTarget.disabled = true;\n            document.querySelector(`.frontendeditor-topbabr`).classList.add(`frontendeditor-loading-data`);\n            fe.loadContent(function () {\n                fe.editableAreas.forEach(function (el) {\n                    if(el.dataset.frontendeditorLoadData)\n                        fe.constructor.tinymceInit(el, fe);\n                });\n                fe.editingMode = true;\n                fe.saved = false;\n                currentTarget.parentElement.classList.toggle(`frontendeditor-edit-mode`);\n                document.querySelector(`body`).classList.add(`frontendeditor-areas-highlight`);\n                currentTarget.disabled = false;\n                document.querySelector(`.frontendeditor-topbabr`).classList.remove(`frontendeditor-loading-data`);\n            }, false);\n        }else{\n            if(fe.saved || !fe.hasChange() || confirm(fe.lexicon['exit_without_saving'])) {\n                tinymce.remove();\n                fe.editingMode = false;\n                currentTarget.disabled = true;\n                document.querySelector(`.frontendeditor-topbabr`).classList.add(`frontendeditor-loading-data`);\n                fe.loadContent(function () {\n                    currentTarget.disabled = false;\n                    document.querySelector(`.frontendeditor-topbabr`).classList.remove(`frontendeditor-loading-data`);\n                }, true);\n\n                currentTarget.parentElement.classList.toggle(`frontendeditor-edit-mode`);\n                document.querySelector(`body`).classList.remove(`frontendeditor-areas-highlight`);\n\n            }\n        }\n    }\n\n    hasChange() {\n        let result = false;\n        this.editableAreas.forEach(function (el) {\n            if(tinyMCE.get(el.id).undoManager.hasUndo())\n                result = true;\n        });\n        return result\n    }\n\n    save() {\n        let data = new FormData();\n        data.append(\"action\", \"update\");\n        data.append(\"id\", this.options.id);\n\n        this.editableAreas.forEach(function (el) {\n            if(el.dataset.frontendeditorLoadData)\n                data.append(el.dataset.frontendeditor, encodeURIComponent(el.innerHTML));\n        });\n\n        this._send(data, function({currentTarget}) {\n            if (currentTarget.status === 200 && currentTarget.response.success) {\n                this.constructor.messageBoxShow().innerHTML = this.lexicon['exit_saving'];\n                this.saved = true;\n            } else {\n                this.constructor.messageBoxShow().innerHTML = `${this.lexicon['error']}<br>${currentTarget.status === 200 ? currentTarget.response.success : currentTarget.status}`;\n            }\n        }.bind(this))\n    }\n\n    _send(data, onloadFunction) {\n        const xhr = new XMLHttpRequest();\n        xhr.open(`POST`, this.options.url);\n        xhr.responseType = 'json';\n        xhr.onload = onloadFunction;\n        xhr.send(data);\n    }\n\n    static messageBoxShow() {\n        let messageBox = document.querySelector(`.frontendeditor-message-box`);\n        messageBox.classList.add(`frontendeditor-box-show`);\n        setTimeout(function () {\n            messageBox.classList.remove(`frontendeditor-box-show`);\n        }, 5000);\n        return messageBox;\n    }\n\n    static tinymceInit(el, fe) {\n\n        let config = {\n            selector: `#${el.id}`,\n            language: fe.options.lang,\n            images_upload_handler: function (blobInfo, success, failure) {\n\n                let formData = new FormData();\n                formData.append('file', blobInfo.blob(), blobInfo.filename());\n                formData.append(\"action\", \"upload\");\n                formData.append(\"id\", fe.options.id);\n\n                fe._send(formData, function({currentTarget}) {\n                    if (currentTarget.status === 200 && currentTarget.response.success) {\n                        success(currentTarget.response.object[`url`]);\n                    } else {\n                        failure('Error: ' + currentTarget.response.message);\n                    }\n                }.bind(this));\n            },\n        };\n\n        if(fe.options.tinymceConfig) {\n            let tinymceConfigString = fe.constructor._decodeEntities(fe.options.tinymceConfig);\n            config = Object.assign(config, JSON.parse(tinymceConfigString));\n        }\n\n        tinymce.init(config);\n    }\n\n    static generateUUID() {\n        let d = new Date().getTime();\n        let d2 = (performance && performance.now && (performance.now()*1000)) || 0;\n        return `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`.replace(/[xy]/g, function(c) {\n            let r = Math.random() * 16;\n            if(d > 0){\n                r = (d + r)%16 | 0;\n                d = Math.floor(d/16);\n            } else {\n                r = (d2 + r)%16 | 0;\n                d2 = Math.floor(d2/16);\n            }\n            return (c === `x` ? r : (r & 0x3 | 0x8)).toString(16);\n        });\n    }\n\n    static _decodeEntities(encodedString) {\n        var textArea = document.createElement('textarea');\n        textArea.innerHTML = encodedString;\n        return textArea.value;\n    }\n\n}\n\nvar frontendeditor = new FrontendEditor();\n\n"]}